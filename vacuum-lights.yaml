blueprint:
  name: LumiÃ¨res robot aspirateur (absence + DND + luminositÃ©) 0.5
  description: >
    Allume/Ã©teint les lumiÃ¨res selon la piÃ¨ce oÃ¹ se trouve le robot.
    Options : prÃ©sence, DND, seuil de luminositÃ©, luminositÃ© fixe/prÃ©cÃ©dente.
  domain: automation

  ###########################################################################
  # ðŸ§¹ ROBOT & PIÃˆCES
  ###########################################################################
  input:

    robot_entity:
      name: Robot aspirateur
      description: Ex : vacuum.roborock_s7
      selector:
        entity:
          domain: vacuum

    current_room_sensor:
      name: Capteur piÃ¨ce actuelle
      description: Ex : sensor.robot_current_room
      selector:
        entity:
          domain: sensor

    room_light_mapping:
      name: Mapping piÃ¨ces â†’ lumiÃ¨res
      description: Ex : {"Salon":"light.salon","Cuisine":"light.cuisine"}
      default: {}
      selector:
        object:


  ###########################################################################
  # ðŸ‘¤ PRÃ‰SENCE (optionnelle)
  ###########################################################################

    enable_presence_check:
      name: Activer la gestion de prÃ©sence
      description: Bloque lâ€™allumage si quelquâ€™un est prÃ©sent.
      default: true
      selector:
        boolean:

    presence_entities:
      name: EntitÃ©s de prÃ©sence
      description: Liste person.* (si prÃ©sence activÃ©e)
      selector:
        target:
          entity:
            domain: person

    presence_state:
      name: Ã‰tat = prÃ©sent
      description: Ex : home
      default: "home"
      selector:
        text:


  ###########################################################################
  # ðŸŒ™ DND (optionnel)
  ###########################################################################

    enable_dnd:
      name: Activer DND
      description: Bloque lâ€™automatisation sur une plage horaire.
      default: false
      selector:
        boolean:

    dnd_start_time:
      name: DÃ©but DND
      default: "22:30"
      selector:
        time:

    dnd_end_time:
      name: Fin DND
      default: "08:00"
      selector:
        time:


  ###########################################################################
  # â˜€ï¸ LUMINOSITÃ‰ (optionnelle)
  ###########################################################################

    enable_luminosity_check:
      name: Activer contrÃ´le luminositÃ©
      description: Nâ€™allume que si la piÃ¨ce est sombre.
      default: false
      selector:
        boolean:

    luminosity_sensor:
      name: Capteur de luminositÃ© (optionnel)
      description: Laisser vide si non utilisÃ©.
      selector:
        target:
          entity:
            domain: sensor
            device_class: illuminance

    luminosity_threshold:
      name: Seuil lux
      default: 50
      selector:
        number:
          min: 0
          max: 2000
          step: 5


  ###########################################################################
  # ðŸ’¡ LUMINOSITÃ‰ DES LAMPES
  ###########################################################################

    brightness_mode:
      name: Mode luminositÃ©
      description: Fixe ou derniÃ¨re valeur
      default: "fixed"
      selector:
        select:
          options:
            - label: "Conserver prÃ©cÃ©dente"
              value: "previous"
            - label: "Fixer un pourcentage"
              value: "fixed"

    brightness_value:
      name: Pourcentage fixe
      default: 100
      selector:
        number:
          min: 1
          max: 100
          step: 1


###############################################################################
# TRIGGERS
###############################################################################

mode: restart

trigger:
  - platform: state
    entity_id: !input robot_entity
  - platform: state
    entity_id: !input current_room_sensor
  - platform: time
    at: !input dnd_start_time
  - platform: time
    at: !input dnd_end_time


###############################################################################
# VARIABLES
###############################################################################

variables:
  robot: !input robot_entity
  room_sensor: !input current_room_sensor
  mapping: !input room_light_mapping

  enable_presence: !input enable_presence_check
  enable_lux: !input enable_luminosity_check

  brightness_mode: !input brightness_mode
  brightness_value: !input brightness_value
  presence_state: !input presence_state
  luminosity_threshold: !input luminosity_threshold

  current_room: "{{ states(room_sensor) }}"

  previous_room: >
    {% if trigger.platform == 'state' and trigger.entity_id == room_sensor %}
      {{ trigger.from_state.state }}
    {% else %}
      {{ none }}
    {% endif %}

  previous_light: >
    {% if previous_room in mapping %}
      {{ mapping[previous_room] }}
    {% endif %}

  # Ã‰tats robot
  is_running: "{{ state_attr(robot, 'running') }}"
  is_paused: "{{ state_attr(robot, 'paused') }}"
  is_charging: "{{ state_attr(robot, 'charging') }}"
  is_docked: "{{ state_attr(robot, 'docked') }}"

  # PrÃ©sence optionnelle
  is_everyone_absent: >
    {% if not enable_presence %}
      true
    {% else %}
      {% set t = input('presence_entities') %}
      {% set present = false %}
      {% for p in t.entity_id %}
        {% if states(p) == presence_state %}
          {% set present = true %}
        {% endif %}
      {% endfor %}
      {{ not present }}
    {% endif %}

  # LuminositÃ© optionnelle (target peut Ãªtre vide)
  is_too_bright: >
    {% if not enable_lux %}
      false
    {% else %}
      {% set t = input('luminosity_sensor') %}
      {% set sensor = t.entity_id[0] if t and t.entity_id|length > 0 else none %}
      {% if sensor == none %}
        false
      {% else %}
        {{ states(sensor) | float > luminosity_threshold }}
      {% endif %}
    {% endif %}

  # DND (gestion minuit)
  is_dnd_active: >
    {% if not input('enable_dnd') %}
      false
    {% else %}
      {% set now_m = now().hour*60 + now().minute %}
      {% set s = str(input('dnd_start_time')).split(':') %}
      {% set e = str(input('dnd_end_time')).split(':') %}
      {% set start_m = s[0]|int*60 + s[1]|int %}
      {% set end_m = e[0]|int*60 + e[1]|int %}
      {% if end_m > start_m %}
        {{ start_m <= now_m < end_m }}
      {% else %}
        {{ now_m >= start_m or now_m < end_m }}
      {% endif %}
    {% endif %}


###############################################################################
# ACTIONS
###############################################################################

action:

  # 1ï¸âƒ£ Allumer dans la piÃ¨ce actuelle
  - choose:
      - conditions:
          - "{{ current_room in mapping }}"
          - "{{ is_running }}"
          - "{{ is_everyone_absent }}"
          - "{{ not is_dnd_active }}"
          - "{{ not is_too_bright }}"
        sequence:
          - choose:
              - conditions: "{{ brightness_mode == 'fixed' }}"
                sequence:
                  - service: light.turn_on
                    target:
                      entity_id: "{{ mapping[current_room] }}"
                    data:
                      brightness_pct: "{{ brightness_value }}"
            default:
              - service: light.turn_on
                target:
                  entity_id: "{{ mapping[current_room] }}"

  # 2ï¸âƒ£ Ã‰teindre lumiÃ¨re piÃ¨ce quittÃ©e
  - choose:
      - conditions:
          - "{{ previous_light is not none }}"
          - "{{ previous_room != current_room }}"
          - "{{ is_running }}"
          - "{{ is_everyone_absent }}"
          - "{{ not is_dnd_active }}"
        sequence:
          - service: light.turn_off
            target:
              entity_id: "{{ previous_light }}"

  # 3ï¸âƒ£ Ã‰teindre lumiÃ¨re si robot stoppe/pausÃ©/dockÃ©
  - choose:
      - conditions:
          - "{{ current_room in mapping }}"
          - "{{ is_paused or is_charging or is_docked }}"
          - "{{ is_everyone_absent }}"
          - "{{ not is_dnd_active }}"
        sequence:
          - delay:
              seconds: >
                {% if is_docked %} 15
                {% else %} 60
                {% endif %}
          - service: light.turn_off
            target:
              entity_id: "{{ mapping[current_room] }}"

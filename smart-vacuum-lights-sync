blueprint:
  name: Smart Vacuum & Light Sync V1.00
  description: "Synchronise les lumières avec le robot aspirateur."
  domain: automation
  input:
    vacuum_entity:
      name: "Vacuum entity"
      description: "Entité vacuum du robot (ex: vacuum.l40s_pro_ultra)"
      selector:
        entity:
          domain: vacuum
    room_sensor:
      name: "Room sensor"
      description: "Capteur indiquant la pièce actuelle du robot"
      selector:
        entity:
          domain: sensor
    lights_mapping_text:
      name: "Room → Light mapping (JSON)"
      description: "Exemple: {\"Salon\":\"light.lumieres_salon\",\"Cuisine\":\"light.lumieres_cuisine\"}"
      selector:
        text: {}
    presence_entities:
      name: "Presence entities (optional)"
      description: "Liste d'entités de présence (person.xxx). Si vide, pas de condition de présence."
      default: []
      selector:
        entity:
          domain: person
          multiple: true
    light_sensor:
      name: "Light sensor (optional)"
      description: "Capteur de luminosité (lux). Si vide, pas de condition de luminosité."
      default: ""
      selector:
        entity:
          domain: sensor
    light_threshold:
      name: "Light threshold (lux)"
      description: "Au-dessus de cette valeur, l'automatisation ne s'exécute pas."
      default: 100
      selector:
        number:
          min: 0
          max: 10000
          unit_of_measurement: lux
    light_brightness:
      name: "Light brightness (optional)"
      description: "Pourcentage de luminosité (0–100). Laisser vide pour un allumage sans réglage."
      default: ""
      selector:
        number:
          min: 0
          max: 100
          step: 1
          unit_of_measurement: "%"

trigger:
  - platform: state
    entity_id: !input room_sensor
  - platform: state
    entity_id: !input vacuum_entity

action:
  - variables:
      room_sensor: !input room_sensor
      vacuum_entity: !input vacuum_entity
      lights_map: !input lights_mapping_text
      presence_entities: !input presence_entities
      light_sensor: !input light_sensor
      light_threshold: !input light_threshold
      light_brightness: !input light_brightness
      room: "{{ states(room_sensor).state }}"
      previous_room: "{{ trigger.from_state.state if trigger.entity_id == room_sensor else '' }}"
      vacuum_state: "{{ states(vacuum_entity).state }}"

  - choose:
      - conditions:
          - condition: template
            value_template: >
              {% set presence_ok = (
                presence_entities | length == 0 or
                (expand(presence_entities) | selectattr('state','eq','home') | list | length == 0)
              ) %}
              {% set lux_ok = (
                light_sensor == "" or
                (states(light_sensor) | float(0) <= light_threshold)
              ) %}
              {{ presence_ok and lux_ok }}
        sequence:
          - choose:
              # Case 1: vacuum en nettoyage ou retour → ON
              - conditions:
                  - condition: template
                    value_template: "{{ vacuum_state in ['cleaning','returning'] and room in (lights_map | from_json) }}"
                sequence:
                  - service: light.turn_on
                    data:
                      brightness_pct: "{{ light_brightness | int if light_brightness != '' else 100 }}"
                    target:
                      entity_id: "{{ (lights_map | from_json)[room] }}"

              # Case 2: vacuum en pause/erreur/idle/dock → OFF
              - conditions:
                  - condition: template
                    value_template: "{{ vacuum_state in ['paused','error','idle','docked'] and room in (lights_map | from_json) }}"
                sequence:
                  - service: light.turn_off
                    target:
                      entity_id: "{{ (lights_map | from_json)[room] }}"

              # Case 3: changement de pièce pendant nettoyage
              - conditions:
                  - condition: template
                    value_template: "{{ trigger.entity_id == room_sensor and vacuum_state in ['cleaning','returning'] }}"
                sequence:
                  # Allumer la nouvelle pièce
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ room in (lights_map | from_json) }}"
                        sequence:
                          - service: light.turn_on
                            data:
                              brightness_pct: "{{ light_brightness | int if light_brightness != '' else 100 }}"
                            target:
                              entity_id: "{{ (lights_map | from_json)[room] }}"
                  # Éteindre la pièce précédente
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: >
                              {{ previous_room != '' and previous_room != room
                                 and previous_room in (lights_map | from_json) }}
                        sequence:
                          - service: light.turn_off
                            target:
                              entity_id: "{{ (lights_map | from_json)[previous_room] }}"

mode: restart

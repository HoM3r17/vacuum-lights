blueprint:
  name: Smart Vacuum & Light Sync V1.0
  description: >
    Sync lights with your vacuum robot.
  domain: automation
  input:
    vacuum_entity:
      name: Vacuum entity
      description: Vacuum robot entity (vacuum.xxx).
      selector:
        entity:
          domain: vacuum
    room_sensor:
      name: Room sensor
      description: Sensor entity indicating the robot's current room.
      selector:
        entity:
          domain: sensor
    lights_mapping_text:
      name: Room → Light mapping (JSON)
      description: >
        Paste a JSON dictionary, e.g.:
        {"Kitchen":"light.kitchen_main","Dining Room":"light.dining_room_main"}
      selector:
        text: {}
    presence_entities:
      name: Presence entities (optional)
      description: >
        List of presence entities (person.xxx). If empty, no presence condition.
      default: []
      selector:
        entity:
          domain: person
          multiple: true
    light_sensor:
      name: Light sensor (optional)
      description: >
        Light sensor entity (lux). If empty, no luminosity condition.
      default: ""
      selector:
        entity:
          domain: sensor
    light_threshold:
      name: Light threshold (lux)
      description: >
        Value above which the automation will not run.
      default: 100
      selector:
        number:
          min: 0
          max: 10000
          unit_of_measurement: lux
    light_brightness:
      name: Light brightness (optional)
      description: >
        Brightness percentage (0–100). Leave empty to just turn on the light without changing brightness.
      default: ""
      selector:
        number:
          min: 0
          max: 100
          step: 1
          unit_of_measurement: "%"

trigger:
  - platform: state
    entity_id: !input room_sensor
  - platform: state
    entity_id: !input vacuum_entity

action:
  - variables:
      room_sensor: !input room_sensor
      vacuum_entity: !input vacuum_entity
      lights_map: !input lights_mapping_text
      presence_entities: !input presence_entities
      light_sensor: !input light_sensor
      light_threshold: !input light_threshold
      light_brightness: !input light_brightness
      room: "{{ states(room_sensor) }}"
      previous_room: "{{ trigger.from_state.state if trigger.entity_id == room_sensor else '' }}"
      vacuum_state: "{{ states(vacuum_entity) }}"

  - choose:
      - conditions:
          - condition: template
            value_template: >
              {% set presence_ok = (
                presence_entities | length == 0 or
                (expand(presence_entities) | selectattr('state','eq','home') | list | length == 0)
              ) %}
              {% set lux_ok = (
                light_sensor == "" or
                (states(light_sensor) | float(0) <= light_threshold)
              ) %}
              {{ presence_ok and lux_ok }}
        sequence:
          - choose:
              # Case 1: vacuum starts or resumes
              - conditions:
                  - condition: template
                    value_template: "{{ vacuum_state in ['cleaning','returning'] and room in (lights_map | from_json) }}"
                sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ light_brightness != '' }}"
                        sequence:
                          - service: light.turn_on
                            data:
                              brightness_pct: "{{ light_brightness | int }}"
                            target:
                              entity_id: "{{ (lights_map | from_json)[room] }}"
                      - conditions:
                          - condition: template
                            value_template: "{{ light_brightness == '' }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: "{{ (lights_map | from_json)[room] }}"
              # Case 2: vacuum stops, pauses, errors or docks
              - conditions:
                  - condition: template
                    value_template: "{{ vacuum_state in ['paused','error','idle','docked'] and room in (lights_map | from_json) }}"
                sequence:
                  - service: light.turn_off
                    target:
                      entity_id: "{{ (lights_map | from_json)[room] }}"
              # Case 3: room change during cleaning
              - conditions:
                  - condition: template
                    value_template: "{{ trigger.entity_id == room_sensor and vacuum_state in ['cleaning','returning'] }}"
                sequence:
                  # Allumer la nouvelle pièce
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ room in (lights_map | from_json) }}"
                        sequence:
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ light_brightness != '' }}"
                                sequence:
                                  - service: light.turn_on
                                    data:
                                      brightness_pct: "{{ light_brightness | int }}"
                                    target:
                                      entity_id: "{{ (lights_map | from_json)[room] }}"
                              - conditions:
                                  - condition: template
                                    value_template: "{{ light_brightness == '' }}"
                                sequence:
                                  - service: light.turn_on
                                    target:
                                      entity_id: "{{ (lights_map | from_json)[room] }}"
                  # Éteindre la pièce précédente
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: >
                              {{ previous_room != '' and previous_room != room
                                 and previous_room in (lights_map | from_json) }}
                        sequence:
                          - service: light.turn_off
                            target:
                              entity_id: "{{ (lights_map | from_json)[previous_room] }}"

mode: restart
